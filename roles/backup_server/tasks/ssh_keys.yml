---
# This task configures SSH between backup server and each client

- name: Backup Server | Make sure .ssh directory exists
  file: path="/home/{{ ansible_ssh_user }}/.ssh-test" state=directory owner="{{ ansible_ssh_user }}" group="{{ ansible_ssh_user }}" mode=0700

- name: Backup Server | Check if SSH key pair exists
  shell: "test -f /home/{{ ansible_ssh_user }}/.ssh/id_rsa"
  register: keypair_exists
  changed_when: keypair_exists.rc != 0
  ignore_errors: True

- name: Backup Server | Create SSH key
  shell: "sudo -u {{ ansible_ssh_user }} ssh-keygen -f '/home/{{ ansible_ssh_user }}/.ssh/id_rsa' -N ''"
  when: keypair_exists.rc != 0

- name: Backup Server | Update SSH private key file permission
  file: path="/home/{{ ansible_ssh_user }}/.ssh/id_rsa" owner="{{ ansible_ssh_user }}" group="{{ ansible_ssh_user }}" mode=0600

- name: Backup Server | Update SSH public key file permission
  file: path="/home/{{ ansible_ssh_user }}/.ssh/id_rsa.pub" owner="{{ ansible_ssh_user }}" group="{{ ansible_ssh_user }}" mode=0644
